--============================================================
				--ELIMINAR TABLAS Y PROCEDURES
--============================================================

DROP TABLE DJML.USUARIOS
DROP TABLE DJML.ROL_FUNCIONALIDAD
DROP TABLE DJML.ROLES
DROP TABLE DJML.FUNCIONALIDAD
DROP TABLE DJML.REGISTRO_DESTINO
DROP TABLE DJML.VIAJES
DROP TABLE DJML.RUTAS
DROP TABLE DJML.COMPRAS
DROP TABLE DJML.CLIENTES
DROP TABLE DJML.ENCOMIENDAS
DROP TABLE DJML.PASAJES
DROP TABLE DJML.TIPO_DOCUMENTO
DROP TABLE DJML.MILLAS
DROP TABLE DJML.CIUDADES
DROP TABLE DJML.BUTACA_AERO
DROP TABLE DJML.BUTACAS
DROP TABLE DJML.TIPO_BUTACA
DROP TABLE DJML.AERONAVES
DROP TABLE DJML.SERVICIOS
DROP TABLE DJML.MEDIOS_DE_PAGO
DROP TABLE DJML.TARJETAS_DE_CREDITO


DROP PROCEDURE DJML.CREAR_AERONAVES
DROP PROCEDURE DJML.CREAR_CIUDADES
DROP PROCEDURE DJML.CREAR_CLIENTES
DROP PROCEDURE DJML.CREAR_ROLES
DROP PROCEDURE DJML.CREAR_RUTAS
DROP PROCEDURE DJML.CREAR_SERVICIOS
DROP PROCEDURE DJML.CREAR_VIAJES 
DROP PROCEDURE DJML.CREAR_FUNCIONALIDADES 
DROP PROCEDURE DJML.CREAR_USUARIOS
DROP PROCEDURE DJML.CREAR_PASAJENCOMIENDA
DROP PROCEDURE DJML.CREAR_COMPRAS

DROP SCHEMA DJML


--============================================================	
--			GESTION DE DATOS 2C 2015 - TP AEROLINEA FRBA						
-- ===========================================================

USE [GD2C2015]
GO

--============================================================	
--		CREACION DEL ESQUEMA CON EL NOMBRE DEL GRUPO--
-- ===========================================================

CREATE SCHEMA [DJML] AUTHORIZATION [GD]
GO

--============================================================
--                EMPEZAMOS A CREAR LAS TABLAS
-- =========================================================== 

CREATE PROCEDURE DJML.CREAR_ROLES
AS
BEGIN

--============================================================
						--TABLA ROLES
--============================================================

	CREATE TABLE DJML.ROLES(
		ROL_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
		ROL_DESCRIPCION VARCHAR(40) NOT NULL,
		ROL_ACTIVO BIT NOT NULL
	)
	PRINT 'SE CREO TABLA ROLES CORRECTAMENTE'
	
	---MIGRACION DATOS TABLA ROLES---
	
	INSERT INTO DJML.ROLES VALUES ('ADMINISTRADOR',1)	
	INSERT INTO DJML.ROLES VALUES ('CLIENTE',1)
	
	
END
GO

CREATE PROCEDURE DJML.CREAR_FUNCIONALIDADES
AS 
BEGIN

--============================================================
				--TABLA FUNCIONALIDADES
--============================================================

	CREATE TABLE DJML.FUNCIONALIDAD(
		FUNC_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
		DESCRIPCION VARCHAR(60) UNIQUE NOT NULL	
	)
	
	PRINT 'SE CREO TABLA FUNCIONALIDAD CORRECTAMENTE'
	
	---MIGRACION DATOS TABLA FUNIONALIDAD---
	
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('ABM ROL')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('ABM CIUDAD')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('ABM RUTA AEREA')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('ABM AERONAVE')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('LOGIN Y SEGURIDAD')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('REGISTRO USUARIO')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('GENERAR VIAJE')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('REGISTRO DE LLEGADA A DESTINO')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('COMPRA PASAJE/ENCOMIENDA')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('DEVOLUCION/CANCELACION PASAJE/ENCOMIENDA')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('CONSULTA MILLAS PASAJERO')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('CANJE MILLAS')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('LISTADO ESTADISTICO')

	
	
--============================================================
					--TABLA ROL_FUNCIONALIDAD
--============================================================

	CREATE TABLE DJML.ROL_FUNCIONALIDAD(
		RXF_ROL_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.ROLES(ROL_ID),
		RXF_FUNC_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.FUNCIONALIDAD(FUNC_ID),
		RXF_HABILITADO BIT
		)		
		PRINT 'SE CREO LA TABLA ROL_FUNCIONALIDAD CORRECTAMENTE'
		
		
		
		---MIGRACION DATOS TABLA ROL_FUNCIONALIDAD---

		---ADMIN
		insert into DJML.ROL_FUNCIONALIDAD (RXF_ROL_ID, RXF_FUNC_ID,RXF_HABILITADO)
		select distinct r.ROL_ID , f.FUNC_ID, 1
		from DJML.ROLES r
		cross join DJML.FUNCIONALIDAD f
		where r.ROL_DESCRIPCION = 'ADMINISTRADOR'

		--CLIENTE
		
		insert into DJML.ROL_FUNCIONALIDAD (RXF_ROL_ID, RXF_FUNC_ID,RXF_HABILITADO)
		select distinct r.ROL_ID , f.FUNC_ID, 1
		from DJML.ROLES r
		cross join DJML.FUNCIONALIDAD f
		where r.ROL_DESCRIPCION = 'CLIENTE'
		and f.DESCRIPCION in ('COMPRA PASAJE/ENCOMIENDA','CONSULTA MILLAS PASAJERO','CANJE MILLAS')	
		
		/*
		---FUNCIONALIDADES DEL ADMIN
		INSERT INTO DJML.ROL_FUNCIONALIDAD VALUES (1, (SELECT FUNC_ID FROM DJML.FUNCIONALIDAD WHERE DESCRIPCION = 'ABM ROL'))
		INSERT INTO DJML.ROL_FUNCIONALIDAD VALUES (1, (SELECT FUNC_ID FROM DJML.FUNCIONALIDAD WHERE DESCRIPCION = 'ABM CIUDAD'))
		INSERT INTO DJML.ROL_FUNCIONALIDAD VALUES (1, (SELECT FUNC_ID FROM DJML.FUNCIONALIDAD WHERE DESCRIPCION = 'ABM RUTA AEREA'))
		INSERT INTO DJML.ROL_FUNCIONALIDAD VALUES (1, (SELECT FUNC_ID FROM DJML.FUNCIONALIDAD WHERE DESCRIPCION = 'ABM AERONAVE'))
		INSERT INTO DJML.ROL_FUNCIONALIDAD VALUES (1, (SELECT FUNC_ID FROM DJML.FUNCIONALIDAD WHERE DESCRIPCION = 'GENERAR VIAJE'))
		INSERT INTO DJML.ROL_FUNCIONALIDAD VALUES (1, (SELECT FUNC_ID FROM DJML.FUNCIONALIDAD WHERE DESCRIPCION = 'REGISTRO DE LLEGADA A DESTINO'))
		INSERT INTO DJML.ROL_FUNCIONALIDAD VALUES (1, (SELECT FUNC_ID FROM DJML.FUNCIONALIDAD WHERE DESCRIPCION = 'COMPRA PASAJE/ENCOMIENDA'))
		INSERT INTO DJML.ROL_FUNCIONALIDAD VALUES (1, (SELECT FUNC_ID FROM DJML.FUNCIONALIDAD WHERE DESCRIPCION = 'DEVOLUCION/CANCELACION PASAJE/ENCOMIENDA'))
		INSERT INTO DJML.ROL_FUNCIONALIDAD VALUES (1, (SELECT FUNC_ID FROM DJML.FUNCIONALIDAD WHERE DESCRIPCION = 'LISTADO ESTADISTICO'))
		INSERT INTO DJML.ROL_FUNCIONALIDAD VALUES (1, (SELECT FUNC_ID FROM DJML.FUNCIONALIDAD WHERE DESCRIPCION = 'CANJE MILLAS'))
		---FUNCIONALIDADES DEL CLIENTE
		INSERT INTO DJML.ROL_FUNCIONALIDAD VALUES (2, (SELECT FUNC_ID FROM DJML.FUNCIONALIDAD WHERE DESCRIPCION = 'COMPRA PASAJE/ENCOMIENDA'))
		INSERT INTO DJML.ROL_FUNCIONALIDAD VALUES (2, (SELECT FUNC_ID FROM DJML.FUNCIONALIDAD WHERE DESCRIPCION = 'CONSULTA MILLAS PASAJERO'))
		INSERT INTO DJML.ROL_FUNCIONALIDAD VALUES (2, (SELECT FUNC_ID FROM DJML.FUNCIONALIDAD WHERE DESCRIPCION = 'CANJE MILLAS'))
		*/
END
GO	

CREATE PROCEDURE DJML.CREAR_USUARIOS
AS 
BEGIN

--============================================================
						--TABLA USUARIOS
--============================================================


	CREATE TABLE DJML.USUARIOS (
		USUA_ID INT NOT NULL IDENTITY(1,1),
		USUA_USERNAME INT NOT NULL PRIMARY KEY,
		USUA_PASSWORD NVARCHAR(40),
		USUA_HABILITADO BIT NOT NULL,
		USUA_LOGIN_FALLIDOS INT NOT NULL,
		USUA_ROL_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.ROLES(ROL_ID)
		)

	PRINT 'SE CREO LA TABLA USUARIOS CORRECTAMENTE'
	
	---MIGRACION DATOS TABLA USUARIOS---
 
	
	INSERT INTO DJML.USUARIOS VALUES (10000000,'w23e',1,0,1)
	INSERT INTO DJML.USUARIOS VALUES (20000000,'w23e',1,0,1)
	INSERT INTO DJML.USUARIOS VALUES (30000000,'w23e',1,0,1)
	INSERT INTO DJML.USUARIOS VALUES (40000000,'w23e',1,0,1)
	
END
GO


CREATE PROCEDURE DJML.CREAR_CIUDADES
AS
BEGIN

--============================================================
						--TABLA CIUDAD
--============================================================

	CREATE TABLE DJML.CIUDADES(
	CIUD_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	CIUD_DETALLE NVARCHAR(255)
	)
	
	PRINT 'SE CREO LA TABLA CIUDAD CORRECTAMENTE'
	
	---MIGRACION DATOS TABLA CIUDADES---
	
	insert into djml.CIUDADES(CIUD_DETALLE)
	select distinct Ruta_Ciudad_Destino from gd_esquema.Maestra
	union
	select distinct ruta_ciudad_origen from gd_esquema.Maestra
		
END 
GO




CREATE PROCEDURE DJML.CREAR_SERVICIOS
AS
BEGIN

--============================================================
						--TABLA SERVICIO
--============================================================

	CREATE TABLE DJML.SERVICIOS(
	SERV_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	SERV_DESCRIPCION NVARCHAR(255) NOT NULL
	)
	PRINT 'SE CREO LA TABLA SERVICIO CORRECTAMENTE'
	
	---MIGRACION DATOS TABLA SERVICIOS---
	
	insert into djml.SERVICIOS(SERV_DESCRIPCION)
	select distinct Tipo_Servicio from gd_esquema.Maestra
	
END
GO

CREATE PROCEDURE DJML.CREAR_RUTAS
AS
BEGIN

--============================================================
						--TABLA RUTA
--============================================================

	CREATE TABLE DJML.RUTAS(
	RUTA_CODIGO INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	RUTA_CODIGO_REAL NUMERIC(18,0) NOT NULL,
	RUTA_CIUDAD_ORIGEN INT NOT NULL FOREIGN KEY REFERENCES DJML.CIUDADES(CIUD_ID),
	RUTA_CIUDAD_DESTINO INT NOT NULL FOREIGN KEY REFERENCES DJML.CIUDADES(CIUD_ID),
	RUTA_SERVICIO_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.SERVICIOS(SERV_ID),
	RUTA_PRECIO_BASE_PASAJE NUMERIC(18,2) NOT NULL,
	RUTA_PRECIO_BASE_KILO NUMERIC(18,2)NOT NULL,
	)

	PRINT 'SE CREO LA TABLA RUTA CORRECTAMENTE'
	
	---MIGRACION DATOS TABLA RUTAS---
	
	insert into DJML.RUTAS(RUTA_CODIGO_REAL,RUTA_CIUDAD_ORIGEN,RUTA_CIUDAD_DESTINO,RUTA_SERVICIO_ID,RUTA_PRECIO_BASE_PASAJE,RUTA_PRECIO_BASE_KILO)
	select distinct 
	m1.Ruta_Codigo
	, (select co.CIUD_ID from DJML.CIUDADES co where co.CIUD_DETALLE = m1.Ruta_Ciudad_Origen)
	, (select cd.CIUD_ID from DJML.CIUDADES cd where cd.CIUD_DETALLE = m1.Ruta_Ciudad_Destino)
	, (select s.SERV_ID from DJML.SERVICIOS s where s.SERV_DESCRIPCION = m1.Tipo_Servicio)
	, (select TOP 1 m2.Ruta_Precio_BaseKG from gd_esquema.Maestra m2 where m2.Ruta_Codigo = m1.Ruta_Codigo and m2.Ruta_Precio_BasePasaje = 0.00)
	, (select TOP 1 m3.Ruta_Precio_BasePasaje from gd_esquema.Maestra m3 where m3.Ruta_Codigo = m1.Ruta_Codigo and m3.Ruta_Precio_BaseKG = 0.00)
	from gd_esquema.Maestra m1
	order by 1
	
END
GO	


CREATE PROCEDURE DJML.CREAR_AERONAVES
AS
BEGIN
	
	
--============================================================
					--TABLA TIPO_BUTACA
--============================================================

	CREATE TABLE DJML.TIPO_BUTACA(
	TIPO_BUTACA_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	DESCRIPCION NVARCHAR(15) NOT NULL,
	) 
	
	PRINT 'SE CREO LA TABLA TIPO_BUTACA CORRECTAMENTE'
	
	---MIGRACION DATOS TABLA TIPO_BUTACA---
	
	INSERT INTO DJML.TIPO_BUTACA(DESCRIPCION)
	SELECT DISTINCT BUTACA_TIPO FROM gd_esquema.Maestra 
	WHERE Butaca_Nro <> 0
	
	
--============================================================
						--TABLA AERONAVE
--============================================================

	CREATE TABLE DJML.AERONAVES(
	AERO_MATRICULA NVARCHAR(7) NOT NULL PRIMARY KEY,
	AERO_MODELO NVARCHAR(50) NOT NULL,
	AERO_FABRICANTE NVARCHAR(50) NOT NULL,
	AERO_KILOS_DISPONIBLES INT NOT NULL,
	AERO_SERVICIO_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.SERVICIOS(SERV_ID),
	AERO_BAJA_FUERA_SERVICIO BIT NOT NULL,
	AERO_BAJA_VIDA_UTIL BIT NOT NULL,
	AERO_FECHA_FUERA_SERVICIO DATETIME,
	AERO_FECHA_REINICIO_SERVICIO DATETIME CHECK(AERO_FECHA_REINICIO_SERVICIO >= AERO_FECHA_REINICIO_SERVICIO),
	AERO_FECHA_BAJA_DEF DATETIME,
	AERO_FECHA_ALTA DATETIME
	)
	
	PRINT 'SE CREO LA TABLA AERONAVE CORRECTAMENTE'
	
	---MIGRACION DATOS TABLA AERONAVES---
	

	insert into djml.AERONAVES(AERO_MATRICULA, AERO_MODELO, AERO_FABRICANTE, AERO_KILOS_DISPONIBLES, AERO_SERVICIO_ID, AERO_BAJA_FUERA_SERVICIO, AERO_BAJA_VIDA_UTIL, AERO_FECHA_FUERA_SERVICIO, AERO_FECHA_REINICIO_SERVICIO, AERO_FECHA_BAJA_DEF, AERO_FECHA_ALTA)
	SELECT distinct AERONAVE_matricula, Aeronave_Modelo, Aeronave_Fabricante, Aeronave_KG_Disponibles, s.SERV_ID, 0,0,NULL, NULL, NULL,NULL
	FROM gd_esquema.Maestra m 
	join djml.SERVICIOS s on  m.Tipo_Servicio = s.SERV_DESCRIPCION
	ORDER BY 1 
	

--============================================================
							--TABLA BUTACA
--============================================================

	CREATE TABLE DJML.BUTACAS(
	BUTA_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	BUTA_NRO NUMERIC(4,0) NOT NULL,
	BUTA_TIPO_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.TIPO_BUTACA(TIPO_BUTACA_ID),
	BUTA_PISO NUMERIC(1,0) NOT NULL
	)
	
	PRINT 'SE CREO LA TABLA BUTACA CORRECTAMENTE'
	
	---MIGRACION DATOS TABLA BUTACAS---
	
	insert into djml.BUTACAS(BUTA_NRO, BUTA_TIPO_ID, BUTA_PISO)
	SELECT distinct Butaca_Nro, n.TIPO_BUTACA_ID, Butaca_Piso
	FROM gd_esquema.Maestra m
	JOIN djml.TIPO_BUTACA n on  m.Butaca_Tipo = n.DESCRIPCION
	WHERE Butaca_Nro <> 0
	order by 1
	
	
--============================================================
							--TABLA BUTACA_AERO
--============================================================

	CREATE TABLE DJML.BUTACA_AERO(
	BXA_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	BXA_BUTA_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.BUTACAS(BUTA_ID),
	BXA_AERO_MATRICULA NVARCHAR(7) NOT NULL FOREIGN KEY REFERENCES DJML.AERONAVES(AERO_MATRICULA),
	BXA_ESTADO BIT NOT NULL
	)
	
	PRINT 'SE CREO LA TABLA BUTACA_AERO CORRECTAMENTE'
	
	---MIGRACION DATOS TABLA BUTACA_AERO---
	
	insert into djml.BUTACA_AERO(BXA_BUTA_ID,BXA_AERO_MATRICULA,BXA_ESTADO)
	select distinct b.BUTA_ID, a.aero_matricula, 1 from gd_esquema.Maestra m
	join djml.AERONAVES a on m.Aeronave_Matricula = a.AERO_MATRICULA
	join djml.TIPO_BUTACA tb on m.Butaca_Tipo = tb.DESCRIPCION 
	join djml.BUTACAS b on tb.TIPO_BUTACA_ID = b.BUTA_TIPO_ID 
	and b.BUTA_NRO = m.Butaca_Nro 
	and b.BUTA_PISO = m.Butaca_Piso 
	where m.Pasaje_Codigo <> 0
	or m.Paquete_Codigo <> 0
	
	--HACER: REVISAR!!
	
END
GO

CREATE PROCEDURE DJML.CREAR_VIAJES
AS
BEGIN

--============================================================
						--TABLA VIAJE
--============================================================

	CREATE TABLE DJML.VIAJES(
	VIAJE_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	VIAJE_FECHA_SALIDA smalldatetime  NOT NULL,
	VIAJE_FECHA_LLEGADA smalldatetime  NULL,
	VIAJE_FECHA_LLEGADA_ESTIMADA  smalldatetime  NOT NULL,
	VIAJE_AERO_ID NVARCHAR(7) NOT NULL FOREIGN KEY REFERENCES DJML.AERONAVES(AERO_MATRICULA),
	VIAJE_RUTA_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.RUTAS(RUTA_CODIGO)
	)
	PRINT 'SE CREO LA TABLA VIAJES CORRECTAMENTE'

	---MIGRACION DATOS TABLA VIAJES---

	insert into djml.VIAJES(VIAJE_FECHA_SALIDA, VIAJE_FECHA_LLEGADA, VIAJE_FECHA_LLEGADA_ESTIMADA, VIAJE_AERO_ID, VIAJE_RUTA_ID)
	select distinct m.FechaSalida, m.FechaLLegada, m.Fecha_LLegada_Estimada, a.aero_matricula, r.RUTA_CODIGO
	from gd_esquema.Maestra m
	join DJML.AERONAVES a on a.AERO_MATRICULA = m.aeronave_matricula
	join djml.RUTAS r on r.RUTA_CODIGO_REAL = m.ruta_codigo 
	where m.Paquete_Codigo <> 0 
	or m.Pasaje_Codigo <> 0
	and m.FechaSalida is not null
	and m.FechaLLegada is not null
	
	--HACER: REVISAR!!
	
--============================================================
					--TABLA REGISTRO_DESTINO
--============================================================

	CREATE TABLE DJML.REGISTRO_DESTINO(
	RD_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	RD_VIAJE_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.VIAJES(VIAJE_ID),
	RD_AERO_ID NVARCHAR(7) NOT NULL FOREIGN KEY REFERENCES DJML.AERONAVES(AERO_MATRICULA),
	RD_FECHA_LLEGADA smalldatetime  NOT NULL ,
	RD_CIUDAD_ORIGEN_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.CIUDADES(CIUD_ID),     
	RD_CIUDAD_DESTINO_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.CIUDADES(CIUD_ID)
	)		
	--LAS CIUDADES ORIGEN/DESTINO REPRESENTAN A LOS AEROPUERTOS PORQUE NO HAY INFORMACION DE ELLOS.
	PRINT 'SE CREO LA TABLA REGISTRO_DESTINO CORRECTAMENTE'

	---MIRAGRACION DATOS TABLA REGISTRO_DESTINO---
	
	--
	--HACER: FALTA MIGRACION!!
	-- PARA MI NO SE MIGRA
END 
GO


CREATE PROCEDURE DJML.CREAR_CLIENTES
AS
BEGIN

--============================================================
						--TABLA CLIENTE
--============================================================
	CREATE TABLE DJML.TIPO_DOCUMENTO(
	ID_TIPO_DOC INT IDENTITY(1,1) PRIMARY KEY,
	DESCRIPCION varchar(15) not null
	)
	
	PRINT 'SE CREO LA TABLA REGISTRO_DESTINO CORRECTAMENTE'
	
	--MIGRACION TABLA TIPO_DOCUMENTO

	INSERT INTO DJML.TIPO_DOCUMENTO (DESCRIPCION) VALUES ('DNI')
	INSERT INTO DJML.TIPO_DOCUMENTO (DESCRIPCION) VALUES ('LC')
	INSERT INTO DJML.TIPO_DOCUMENTO (DESCRIPCION) VALUES ('LE')

	
	CREATE TABLE DJML.CLIENTES(
	CLIE_DNI INT NOT NULL,
	CLIE_TIPO_DOC INT NOT NULL FOREIGN KEY REFERENCES DJML.TIPO_DOCUMENTO(ID_TIPO_DOC),
	CLIE_NOMBRE NVARCHAR(255) NOT NULL,
	CLIE_APELLIDO NVARCHAR(255)NOT NULL,
	CLIE_DIRECCION NVARCHAR(255)NOT NULL,
	CLIE_EMAIL NVARCHAR(255),
	CLIE_TELEFONO NUMERIC(18,0) NOT NULL,
	CLIE_FECHA_NACIMIENTO DATETIME NOT NULL,
	CONSTRAINT PK_CLIENTES PRIMARY KEY (CLIE_DNI,CLIE_TIPO_DOC)
	)

	PRINT 'SE CREO LA TABLA CLIENTE CORRECTAMENTE'

	---MIGRACION DATOS TABLA CLIENTES---
	
	insert into djml.CLIENTES(CLIE_DNI,CLIE_TIPO_DOC,CLIE_NOMBRE,CLIE_APELLIDO,CLIE_DIRECCION,CLIE_EMAIL, CLIE_TELEFONO, CLIE_FECHA_NACIMIENTO)
	select distinct Cli_Dni,t.ID_TIPO_DOC, Cli_Nombre,Cli_Apellido,Cli_Dir, Cli_Mail,Cli_Telefono,Cli_Fecha_Nac from gd_esquema.Maestra
	join djml.TIPO_DOCUMENTO t on t.DESCRIPCION = 'DNI' 
	where ((Pasaje_Codigo <> 0) or (Paquete_Codigo <> 0))
	AND Cli_Mail <> 'orencia@gmail.com'
	union
	select distinct Cli_Dni,t.ID_TIPO_DOC, Cli_Nombre,Cli_Apellido,Cli_Dir, Cli_Mail,Cli_Telefono,Cli_Fecha_Nac from gd_esquema.Maestra
	join djml.TIPO_DOCUMENTO t on t.DESCRIPCION = 'LE' 
	where ((Pasaje_Codigo <> 0) or (Paquete_Codigo <> 0))
	AND Cli_Mail = 'orencia@gmail.com'
	
	--HACER: REVISAR!!

--============================================================
						--TABLA MILLAS
--============================================================

/*  FALTA DEFINIR !!!!!!!!!!!
CREATE TABLE DJML.MILLAS(
	MILLAS_CLIENTE INT NOT NULL FOREIGN KEY REFERENCES DJML.CLIENTES(CLIE_DNI), 
	)
	PRINT 'SE CREO LA TABLA MILLAS CORRECTAMENTE'
	---MIGRACION DATOS TABLA MILLAS ---
	*/


END
GO


CREATE PROCEDURE DJML.CREAR_PASAJENCOMIENDA
AS
BEGIN
--============================================================
						--TABLA PASAJE
--============================================================
	CREATE TABLE DJML.PASAJES (
	PASA_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	PASA_VIAJE_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.VIAJES(VIAJE_ID),
	PASA_CLIE_DNI INT NOT NULL,
	PASA_CLIE_TIPO_DOC INT NOT NULL,
	PASA_BUTA_ID INT FOREIGN KEY REFERENCES DJML.BUTACA_AERO(BXA_ID) NOT NULL,
	CONSTRAINT FK_PASA_CLIENTES FOREIGN KEY (PASA_CLIE_DNI, PASA_CLIE_TIPO_DOC) REFERENCES DJML.CLIENTES (CLIE_DNI, CLIE_TIPO_DOC) 
	)

	PRINT 'SE CREO LA TABLA PASAJE CORRECTAMENTE'

	----- FALTA MIGRAR ESTA TABLA!!!!!!
	----------------------------------------------
	------------------------------------------------------------
	----------------------------------------------------------------------------
	---------------------------------------------------------------------------------------



--============================================================
						--TABLA EMBALAJE
--============================================================
	CREATE TABLE DJML.ENCOMIENDAS (
	ENCO_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	ENCO_VIAJE_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.VIAJES(VIAJE_ID),
	ENCO_CLIE_DNI INT NOT NULL,
	ENCO_CLIE_TIPO_DOC INT NOT NULL,
	ENCO_KG INT NOT NULL,
	CONSTRAINT FK_ENCO_CLIENTES FOREIGN KEY (ENCO_CLIE_DNI, ENCO_CLIE_TIPO_DOC) REFERENCES DJML.CLIENTES(CLIE_DNI, CLIE_TIPO_DOC) 
	)

	PRINT 'SE CREO LA TABLA ENCOMIENDA CORRECTAMENTE'

	----- FALTA MIGRAR ESTA TABLA!!!!!!
	----------------------------------------------
	------------------------------------------------------------
	----------------------------------------------------------------------------
	---------------------------------------------------------------------------------------
	
END
GO


CREATE PROCEDURE DJML.CREAR_COMPRAS
AS 
BEGIN
--=======================================================================
                            -- TABLA MEDIO DE PAGO
--=======================================================================
	CREATE TABLE DJML.MEDIOS_DE_PAGO(
	MEDI_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	MEDI_DESCRIPCION VARCHAR(15) NOT NULL
	)

	--MIGRACION

	INSERT INTO DJML.MEDIOS_DE_PAGO(MEDI_DESCRIPCION) VALUES ('EFECTIVO')
	INSERT INTO DJML.MEDIOS_DE_PAGO(MEDI_DESCRIPCION) VALUES ('TC')

	--=======================================================================
                            -- TABLA TIPOS DE TARJETA
--=======================================================================


	CREATE TABLE DJML.TIPOS_DE_TARJETA (
    ID   INT   IDENTITY(1,1)     PRIMARY KEY,
    NOMBRE    NVARCHAR(255) NOT NULL,
	CUOTAS INT DEFAULT 0   
)

 -- Migracion

	INSERT INTO DJML.TIPOS_DE_TARJETA (NOMBRE, CUOTAS)
	VALUES ('VISA', 6),
	('MASTERCARD', 12),
	('AMEX', 3),
	('DINERS', 0);

--=======================================================================
                            -- TABLA TARJETA DE CREDITO
--=======================================================================
	CREATE TABLE DJML.TARJETAS_DE_CREDITO(
	TARJ_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	TARJ_NUMERO BIGINT NOT NULL,
	TARJ_TIPO_ID INT FOREIGN KEY REFERENCES DJML.TIPOS_DE_TARJETA(ID), 
	TARJ_VENCIMIENTO INT,
	TARJ_CODIGO_SEGURIDAD INT

	)

--=======================================================================
                            -- TABLA COMPRA
--=======================================================================

	DROP TABLE DJML.COMPRAS
	CREATE TABLE DJML.COMPRAS(
	COMPRA_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	COMPRA_ID_USUARIO INT FOREIGN KEY REFERENCES DJML.USUARIOS(USUA_USERNAME),
	COMPRA_MEDIO_DE_PAGO INT FOREIGN KEY REFERENCES DJML.MEDIOS_DE_PAGO(MEDI_ID) NOT NULL,
	COMPRA_TARJETA_DE_CREDITO INT FOREIGN KEY REFERENCES DJML.TARJETAS_DE_CREDITO(TARJ_ID),
	COMPRA_ID_MONTO NUMERIC(18,0),
	COMPRA_FECHA DATETIME,
	COMPRA_CLIE_DNI INT NOT NULL,
	COMPRA_CLIE_TIPO_DOC INT NOT NULL, 
	CONSTRAINT FK_COMPRAS_CLIENTES FOREIGN KEY (COMPRA_CLIE_DNI, COMPRA_CLIE_TIPO_DOC) REFERENCES DJML.CLIENTES (CLIE_DNI, CLIE_TIPO_DOC) 
)

	-- MIGRACION DATOS TABLA COMPRAS ---
	-- PARA MI NO SE MIGRA -- 

END 
GO


--============================================================
						--EJECUTAR PROCEDURES
--============================================================

EXEC DJML.CREAR_ROLES
EXEC DJML.CREAR_FUNCIONALIDADES
EXEC DJML.CREAR_USUARIOS
EXEC DJML.CREAR_SERVICIOS
EXEC DJML.CREAR_CIUDADES
EXEC DJML.CREAR_RUTAS
EXEC DJML.CREAR_AERONAVES
EXEC DJML.CREAR_VIAJES
EXEC DJML.CREAR_CLIENTES
EXEC DJML.CREAR_PASAJENCOMIENDA
EXEC DJML.CREAR_COMPRAS



