--============================================================	
--			GESTION DE DATOS 2C 2015 - TP AEROLINEA FRBA						
-- ===========================================================

USE [GD2C2015]
GO

--============================================================	
--		CREACION DEL ESQUEMA CON EL NOMBRE DEL GRUPO--
-- ===========================================================

CREATE SCHEMA [DJML] AUTHORIZATION [GD]
GO

--============================================================
--                EMPEZAMOS A CREAR LAS TABLAS
-- =========================================================== 

CREATE PROCEDURE DJML.CREAR_ROLES
AS
BEGIN

--============================================================
						--TABLA ROLES
--============================================================

	CREATE TABLE DJML.ROLES(
		ROL_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
		ROL_DESCRIPCION VARCHAR(40) NOT NULL,
		ROL_ESTADO BIT NOT NULL
	)
	PRINT 'SE CREO TABLA ROLES CORRECTAMENTE'
	
	
	--INGRESAMOS EL ADMIN
	INSERT INTO DJML.ROLES VALUES ('ADMINISTRADOR',1)	
	
END
GO

CREATE PROCEDURE DJML.CREAR_FUNCIONALIDADES
AS 
BEGIN

--============================================================
				--TABLA FUNCIONALIDADES
--============================================================

	CREATE TABLE DJML.FUNCIONALIDAD(
		FUNC_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
		DESCRIPCION VARCHAR(60) UNIQUE NOT NULL	
	)
	PRINT 'SE CREO TABLA FUNCIONALIDAD CORRECTAMENTE'
	
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('ABM ROL')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('ABM CIUDAD')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('ABM RUTA AEREA')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('ABM AERONAVE')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('LOGIN Y SEGURIDAD')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('REGISTRO USUARIO')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('GENERAR VIAJE')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('REGISTRO DE LLEGADA A DESTINO')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('COMPRA PASAJE/ENCOMIENDA')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('DEVOLUCION/CANCELACION PASAJE/ENCOMIENDA')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('CONSULTA MILLAS PASAJERO')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('CANJE MILLAS')
	INSERT INTO DJML.FUNCIONALIDAD VALUES ('LISTADO ESTADISTICO')
	
	
	
--============================================================
					--TABLA ROL_FUNCIONALIDAD
--============================================================

	CREATE TABLE DJML.ROL_FUNCIONALIDAD(
		RXF_ROL_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.ROLES(ROL_ID),
		RXF_FUNC_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.FUNCIONALIDAD(FUNC_ID),
		RXF_ESTADO BIT NOT NULL,
		CONSTRAINT RXF_PK PRIMARY KEY(RXF_ROL_ID,RXF_FUNC_ID)
		)		
		PRINT 'SE CREO LA TABLA ROL_FUNCIONALIDAD CORRECTAMENTE'
END
GO	

CREATE PROCEDURE DJML.CREAR_USUARIOS
AS 
BEGIN

--============================================================
						--TABLA USUARIOS
--============================================================


	CREATE TABLE DJML.USUARIOS (
		USUA_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
		USUA_USERNAME NVARCHAR(40) NOT NULL UNIQUE,
		USUA_PASSWORD NVARCHAR(40),
		USUA_HABILITADO BIT NOT NULL,
		USU_LOGIN_FALLIDOS INT NOT NULL,
		)

	PRINT 'SE CREO LA TABLA USUARIOS CORRECTAMENTE'
	
	 
	
END
GO


CREATE PROCEDURE DJML.CREAR_CIUDADES
AS
BEGIN

--============================================================
						--TABLA CIUDAD
--============================================================

	CREATE TABLE DJML.CIUDADES(
	CIUD_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	CIUD_DETALLE NVARCHAR(255)
	)
	
	PRINT 'SE CREO LA TABLA CIUDAD CORRECTAMENTE'
	
	insert into djml.CIUDADES(CIUD_DETALLE)
	select distinct Ruta_Ciudad_Destino from gd_esquema.Maestra
	
	
END 
GO


CREATE PROCEDURE DJML.CREAR_RUTAS
AS
BEGIN

--============================================================
						--TABLA RUTA
--============================================================

	CREATE TABLE DJML.RUTAS(
	RUTA_CODIGO NUMERIC(18,0) NOT NULL PRIMARY KEY,
	RUTA_CIUDAD_ORIGEN INT NOT NULL FOREIGN KEY REFERENCES DJML.CIUDADES(CIUD_ID),
	RUTA_CIUDAD_DESTINO INT NOT NULL FOREIGN KEY REFERENCES DJML.CIUDADES(CIUD_ID),
	RUTA_SERVICIO_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.SERVICIOS(SERV_ID),
	RUTA_PRECIO_BASE_PASAJE NUMERIC(18,2) NOT NULL,
	RUTA_PRECIO_BASE_KILO NUMERIC(18,2)NOT NULL,
	)

	PRINT 'SE CREO LA TABLA RUTA CORRECTAMENTE'
	
	/*
	
	insert into djml.RUTAS(RUTA_CODIGO,RUTA_CIUDAD_ORIGEN,RUTA_CIUDAD_DESTINO,RUTA_SERVICIO_ID,RUTA_PRECIO_BASE_PASAJE,RUTA_PRECIO_BASE_KILO)
	select distinct ruta_codigo, Ruta_Ciudad_Origen,Ruta_Ciudad_Destino, s.SERV_DESCRIPCION as RUTA_SERVICIO,(Ruta_Precio_BasePasaje),(Ruta_Precio_BaseKG) from gd_esquema.Maestra m 
	join djml.SERVICIOS s on s.SERV_DESCRIPCION = m.Tipo_Servicio
	group by Ruta_Codigo,Ruta_Ciudad_Origen,Ruta_Ciudad_Destino, s.SERV_DESCRIPCION,Ruta_Precio_BasePasaje,Ruta_Precio_BaseKG
	
	----VER COMO ELIMINAR LOS 0 DE LOS PRECIOS.
	----HACER GROUP BY Y SUM
	*/	
END
GO	


CREATE PROCEDURE DJML.CREAR_SERVICIOS
AS
BEGIN

--============================================================
						--TABLA SERVICIO
--============================================================

	CREATE TABLE DJML.SERVICIOS(
	SERV_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	SERV_DESCRIPCION NVARCHAR(255) NOT NULL
	)
	PRINT 'SE CREO LA TABLA SERVICIO CORRECTAMENTE'
	
	insert into djml.SERVICIOS(SERV_DESCRIPCION)
	select distinct Tipo_Servicio from gd_esquema.Maestra
	
END
GO


CREATE PROCEDURE DJML.CREAR_AERONAVES
AS
BEGIN
	
	
--============================================================
					--TABLA TIPO_BUTACA
--============================================================

	CREATE TABLE DJML.TIPO_BUTACA(
	TIPO_BUTACA_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	DESCRIPCION NVARCHAR(15) NOT NULL,
	) 
	
	PRINT 'SE CREO LA TABLA TIPO_BUTACA CORRECTAMENTE'
	
	INSERT INTO DJML.TIPO_BUTACA(DESCRIPCION)
	SELECT DISTINCT BUTACA_TIPO FROM gd_esquema.Maestra 
	WHERE Butaca_Nro <> 0
	
	
--============================================================
						--TABLA AERONAVE
--============================================================

	CREATE TABLE DJML.AERONAVES(
	AERO_MATRICULA NVARCHAR(7) NOT NULL PRIMARY KEY,
	AERO_MODELO NVARCHAR(50) NOT NULL,
	AERO_FABRICANTE NVARCHAR(50) NOT NULL,
	AERO_SERVICIO_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.SERVICIOS(SERV_ID),
	AERO_BAJA_FUERA_SERVICIO BIT NOT NULL,
	AERO_BAJA_VIDA_UTIL BIT NOT NULL,
	AERO_FECHA_FUERA_SERVICIO DATETIME,
	AERO_FECHA_REINICIO_SERVICIO DATETIME CHECK(AERO_FECHA_REINICIO_SERVICIO >= AERO_FECHA_REINICIO_SERVICIO),
	AERO_FECHA_BAJA_DEF DATETIME,
	AERO_KILOS_DISPONIBLES INT NOT NULL
	)
	
	PRINT 'SE CREO LA TABLA AERONAVE CORRECTAMENTE'
	
	
--============================================================
							--TABLA BUTACA
--============================================================

	CREATE TABLE DJML.BUTACAS(
	BUTA_ID NUMERIC(4,0) NOT NULL PRIMARY KEY,
	BUTA_TIPO_ID INT NOT NULL FOREIGN KEY REFERENCES DJML.TIPO_BUTACA(TIPO_BUTACA_ID),
	BUTA_PISO NUMERIC(1,0) NOT NULL
	)
 
	PRINT 'SE CREO LA TABLA BUTACA CORRECTAMENTE'
	




	CREATE TABLE DJML.AERO_BUTACA(
	AE_BUTA_ID NUMERIC(4,0) NOT NULL FOREIGN KEY REFERENCES DJML.BUTACAS(BUTA_ID),
	AE_AERO_MATRICULA NVARCHAR(7) NOT NULL FOREIGN KEY REFERENCES DJML.AERONAVES(AERO_MATRICULA),
	AE_ESTADO BIT NOT NULL,
	CONSTRAINT AE_PK PRIMARY KEY(AE_BUTA_ID,AE_AERO_MATRICULA))

	PRINT 'SE CREO LA TABLA AERO_BUTACA CORRECTAMENTE'
END
GO

CREATE PROCEDURE DJML.CREAR_VIAJES
AS
BEGIN

--============================================================
						--TABLA VIAJE
--============================================================

	CREATE TABLE DJML.VIAJES(
	VIAJE_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	VIAJE_FECHA_SALIDA DATETIME NOT NULL,
	VIAJE_FECHA_LLEGADA DATETIME NOT NULL,
	VIAJE_FECHA_LLEGADA_ESTIMADA DATETIME NOT NULL,
	VIAJE_AERO_ID NVARCHAR(7) NOT NULL FOREIGN KEY REFERENCES DJML.AERONAVES(AERO_MATRICULA),
	VIAJE_RUTA_ID NUMERIC(18,0) NOT NULL FOREIGN KEY REFERENCES DJML.RUTAS(RUTA_CODIGO)
	)

	PRINT 'SE CREO LA TABLA VIAJES CORRECTAMENTE'
	
--============================================================
					--TABLA REGISTRO_DESTINO
--============================================================

	CREATE TABLE DJML.REGISTRO_DESTINO(
	RD_ID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
	RD_AERO_ID NVARCHAR(7) NOT NULL FOREIGN KEY REFERENCES DJML.AERONAVES(AERO_MATRICULA),
	RD_FECHA_LLEGADA DATETIME)
	--RD_AEROPUERTO_ORIGEN_ID       ///VER SI HAY AEROPUERTOS O NO
	--RD_AEROPUERTO_DESTINO_ID		///VER SI HAY AEROPUERTOS O NO	
	
	PRINT 'SE CREO LA TABLA REGISTRO_DESTINO CORRECTAMENTE'
END 
GO


CREATE PROCEDURE DJML.CREAR_CLIENTES
AS
BEGIN

--============================================================
						--TABLA CLIENTE
--============================================================

	CREATE TABLE DJML.CLIENTES(
	CLIE_DNI INT NOT NULL PRIMARY KEY,
	CLIE_NOMBRE NVARCHAR(255) NOT NULL,
	CLIE_APELLIDO NVARCHAR(255)NOT NULL,
	CLIE_DIRECCION NVARCHAR(255)NOT NULL,
	CLIE_EMAIL NVARCHAR(255),
	CLIE_TELEFONO NUMERIC(18,0) NOT NULL,
	CLIE_FECHA_NACIMIENTO DATETIME NOT NULL
	)

	PRINT 'SE CREO LA TABLA CLIENTE CORRECTAMENTE'

END
GO

--============================================================
						--EJECUTAR PROCEDURES
--============================================================

EXEC DJML.CREAR_ROLES
EXEC DJML.CREAR_FUNCIONALIDADES
EXEC DJML.CREAR_USUARIOS
EXEC DJML.CREAR_SERVICIOS
EXEC DJML.CREAR_CIUDADES
EXEC DJML.CREAR_RUTAS
EXEC DJML.CREAR_AERONAVES
EXEC DJML.CREAR_VIAJES
EXEC DJML.CREAR_CLIENTES

--============================================================
				--ELIMINAR TABLAS Y PROCEDURES
--============================================================


DROP TABLE DJML.ROL_FUNCIONALIDAD
DROP TABLE DJML.ROLES
DROP TABLE DJML.FUNCIONALIDAD
DROP TABLE DJML.USUARIOS
DROP TABLE DJML.VIAJES
DROP TABLE DJML.RUTAS
DROP TABLE DJML.CLIENTES
DROP TABLE DJML.CIUDADES
DROP TABLE DJML.REGISTRO_DESTINO
DROP TABLE DJML.BUTACAS
DROP TABLE DJML.AERONAVES
DROP TABLE DJML.TIPO_BUTACA
DROP TABLE DJML.SERVICIOS



DROP PROCEDURE DJML.CREAR_AERONAVES
DROP PROCEDURE DJML.CREAR_CIUDADES
DROP PROCEDURE DJML.CREAR_CLIENTES
DROP PROCEDURE DJML.CREAR_ROLES
DROP PROCEDURE DJML.CREAR_RUTAS
DROP PROCEDURE DJML.CREAR_SERVICIOS
DROP PROCEDURE DJML.CREAR_VIAJES 
DROP PROCEDURE DJML.CREAR_FUNCIONALIDADES 
DROP PROCEDURE DJML.CREAR_USUARIOS





